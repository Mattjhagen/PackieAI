<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PacMac Mobile</title>
  <meta name="description" content="PacMac Mobile e‑commerce site for trade‑ins, leasing, and Nomad Internet." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>📱</text></svg>">
  <script src="config.js"></script>
  <style>
    :root{
      --bg: #000;
      --fg: #eaeaea;
      --muted:#9aa0a6;
      --accent:#6aa7ff;
      --accent-2:#8affd1;
      --card:#0b0b0b;
      --ring:#1f2937;
      --shadow: 0 10px 25px rgba(0,0,0,.6), 0 2px 6px rgba(0,0,0,.5);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); background:var(--bg);
      font: 16px/1.45 -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      overflow-x:hidden;
    }

    /* Starfield canvas sits behind everything */
    #stars{position:fixed; inset:0; z-index:-1; display:block; background:#000}

    header{
      position:sticky; top:0; backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(0,0,0,.8), rgba(0,0,0,.3));
      border-bottom:1px solid #111; z-index:20;
    }
    .nav{max-width:1200px;margin:0 auto;display:flex;gap:18px;align-items:center; padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center; font-weight:600; letter-spacing:.2px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 20px var(--accent)}
    .spacer{flex:1}
    .nav a, .nav button.link{color:var(--fg); text-decoration:none; opacity:.9}
    .nav a:hover, .nav button.link:hover{opacity:1}
    .nav .pill{padding:8px 14px; border:1px solid #1a1a1a; border-radius:9999px; background:#0b0b0b}

    .hero{max-width:1200px;margin:40px auto 10px; padding:0 16px; display:grid; gap:18px}
    .hero h1{font-size:clamp(28px, 4vw, 48px); margin:0; letter-spacing:-.02em}
    .hero p{color:var(--muted); margin:0}
    .cta-row{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px}
    .btn{border-radius:9999px; padding:10px 16px; border:1px solid #1a1a1a; background:linear-gradient(180deg, #0f0f0f, #080808); color:var(--fg); cursor:pointer; box-shadow:var(--shadow)}
    .btn:hover{transform:translateY(-1px)}

    .section{max-width:1200px; margin:28px auto; padding:0 16px}
    .grid{display:grid; gap:16px; grid-template-columns:repeat(12, 1fr)}
    .card{grid-column: span 4; background:var(--card); border:1px solid #131313; border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); position:relative; transform-style:preserve-3d; transition:transform 0.8s ease-in-out; cursor:pointer}
    .card.flipped{transform:rotateY(180deg)}
    .card-front,.card-back{position:absolute; width:100%; height:100%; backface-visibility:hidden; display:flex; flex-direction:column}
    .card-back{transform:rotateY(180deg); background:var(--card); padding:16px; justify-content:space-between}
    .card .img{aspect-ratio: 16/12; display:flex; align-items:center; justify-content:center; background: radial-gradient(60% 60% at 50% 50%, rgba(106,167,255,.15), transparent 60%)}
    .card h3{margin:10px 14px 6px}
    .card p{margin:0 14px 10px; color:var(--muted)}
    .price-row{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 14px 14px}
    .specs-list{list-style:none; padding:0; margin:16px 0; font-size:14px}
    .specs-list li{padding:6px 0; border-bottom:1px solid #161616; display:flex; justify-content:space-between}
    .specs-list li:last-child{border-bottom:none}
    .specs-label{color:var(--muted); font-weight:500}
    .specs-value{color:var(--fg)}
    .flip-indicator{position:absolute; top:8px; right:8px; background:rgba(0,0,0,.7); color:var(--fg); padding:4px 8px; border-radius:6px; font-size:12px; opacity:0; transition:opacity 0.3s; pointer-events:none}
    .card:hover .flip-indicator{opacity:1}
    .card::after{content:'↻'; position:absolute; bottom:8px; right:8px; background:var(--accent); color:#000; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:bold; opacity:0.7; transition:opacity 0.3s}
    .card:hover::after{opacity:1}
    
    /* Add to Cart Animation */
    .add-to-cart-animation{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--accent); color:#000; padding:16px 24px; border-radius:12px; font-weight:600; z-index:1000; animation:cartBounce 0.8s ease-out forwards; pointer-events:none}
    @keyframes cartBounce{0%{opacity:0; transform:translate(-50%,-50%) scale(0.5)} 50%{opacity:1; transform:translate(-50%,-50%) scale(1.2)} 100%{opacity:0; transform:translate(-50%,-50%) scale(1)}}
    
    /* Accessories Section */
    .accessories-section{display:none; margin-top:40px}
    .accessories-section.active{display:block; animation:fadeInUp 0.6s ease-out}
    @keyframes fadeInUp{from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)}}
    .accessories-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); margin-top:20px}
    .accessory-card{background:var(--card); border:1px solid #131313; border-radius:var(--radius); padding:16px; text-align:center; transition:transform 0.2s, box-shadow 0.2s}
    .accessory-card:hover{transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,.3)}
    .accessory-card img{width:80px; height:80px; object-fit:contain; margin:0 auto 12px; border-radius:8px}
    .accessory-card h4{margin:0 0 8px; font-size:16px}
    .accessory-card .price{color:var(--accent); font-weight:600; margin:8px 0}
    .accessory-card .compatibility{font-size:12px; color:var(--muted); margin-bottom:12px}
    .back-to-products{background:var(--accent); color:#000; border:none; padding:12px 20px; border-radius:8px; font-weight:600; cursor:pointer; margin-bottom:20px; transition:opacity 0.2s}
    .back-to-products:hover{opacity:0.9}
    .chip{padding:4px 10px; border-radius:9999px; border:1px solid #1b1b1b; background:#0a0a0a; color:#c7c7c7; font-size:12px}

    .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}

    .panel{background:var(--card); border:1px solid #131313; border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .panel h3{margin:0 0 6px}
    .panel p{margin:0 0 12px; color:var(--muted)}

    .two-col{display:grid; gap:16px; grid-template-columns: 1fr 1fr}

    footer{max-width:1200px;margin:40px auto 80px; padding:0 16px; color:#a0a0a0}
    footer .cols{display:grid; grid-template-columns: repeat(4, 1fr); gap:16px}

    .cart-fab{position:fixed; right:16px; bottom:16px; z-index:25}
    .cart-fab .count{position:absolute; top:-6px; right:-6px; background:var(--accent); color:#000; font-weight:700; font-size:12px; border-radius:9999px; padding:2px 6px}

    dialog.modal{border:none; border-radius:20px; padding:0; background:#0b0b0b; color:var(--fg); width:min(720px, 92vw); box-shadow:0 30px 80px rgba(0,0,0,.75)}
    dialog::backdrop{background: rgba(0,0,0,.6)}
    .modal .hd{display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid #161616}
    .modal .bd{padding:16px}
    .modal .ft{padding:12px 16px; border-top:1px solid #161616; display:flex; justify-content:flex-end; gap:10px}

    /* Responsive */
    @media (max-width: 980px){ .card{grid-column: span 6} .two-col{grid-template-columns: 1fr} footer .cols{grid-template-columns: repeat(2, 1fr)} }
    @media (max-width: 640px){ 
      .card{grid-column: span 12} 
      .card{transform-style:flat} /* Disable 3D transforms on mobile for better performance */
      .card.flipped{transform:none} /* Use opacity-based flip on mobile */
      .card-back{transform:none; opacity:0; transition:opacity 0.4s}
      .card.flipped .card-back{opacity:1}
      .card.flipped .card-front{opacity:0}
      .card-front{opacity:1; transition:opacity 0.4s}
      footer .cols{grid-template-columns: 1fr} 
    }

    /* Tiny helpful animations */
    .glow{box-shadow: 0 0 0 1px #1a1a1a, 0 0 30px rgba(106,167,255,.15)}
    .pulse{animation:pulse 2.2s ease-in-out infinite}
    @keyframes pulse{0%,100%{opacity:.9} 50%{opacity:1}}
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>
</head>
<body>
  <canvas id="stars" aria-hidden="true"></canvas>
  <header>
    <nav class="nav">
      <div class="brand" aria-label="PacMac Mobile">
        <span class="dot" aria-hidden="true"></span>
        <span>PacMac Mobile</span>
      </div>
      <a href="#shop" class="pill">Shop</a>
      <a href="#tradein" class="pill">Trade‑In</a>
      <a href="#lease" class="pill">Lease‑to‑Own</a>
      <a href="#internet" class="pill">Unlimited Internet</a>
      <a href="#support" class="pill">Support</a>
      <div class="spacer"></div>
      <button class="link" id="open-cart" aria-label="Open cart">Cart</button>
    </nav>
  </header>

  <main>
    <section class="hero" id="top">
      <h1>PacMac Mobile LLC</h1>
      <p>1402 Jones Street | Omaha, NE 68901</p>
      <div class="cta-row">
        <a class="btn" href="#shop">Browse Devices</a>
        <button class="btn" id="btn-apple-trade">Apple Authorized Repairs</button>
        <button class="btn" id="btn-phobio-quote">Trade-in</button>
        <button class="btn" id="btn-progressive">Lease with Progressive</button>
        <button class="btn" id="btn-nomad">Nomad Internet</button>
      </div>
    </section>

    <section class="section" id="shop" aria-label="Products">
      <h2 style="margin:6px 0 10px">Featured Devices</h2>
      <div class="grid" id="product-grid" role="list"></div>
      
      <!-- Accessories Section -->
      <div class="accessories-section" id="accessories-section">
        <button class="back-to-products" id="back-to-products">← Back to Products</button>
        <h2 id="accessories-title" style="margin:6px 0 10px">Compatible Accessories</h2>
        <p id="accessories-subtitle" style="color:var(--muted); margin-bottom:20px">Enhance your device with these recommended accessories</p>
        <div class="accessories-grid" id="accessories-grid"></div>
      </div>
    </section>

    <section class="section two-col" id="tradein">
      <div class="panel glow">
        <h3>Phobio Trade‑In</h3>
        <p>Instant trade-ins, use for cash or store credit.</p>
        <div class="row">
          <input id="phobio-model" class="chip" placeholder="Device model (e.g., iPhone 13)" />
          <select id="phobio-cond" class="chip" aria-label="Condition">
            <option>Like New</option>
            <option>Good</option>
            <option>Fair</option>
            <option>Broken</option>
          </select>
          <button class="btn" id="phobio-get-quote">Get Quote</button>
        </div>
        <div id="phobio-output" style="margin-top:10px"></div>
      </div>
      <div class="panel">
        <h3>Apple Authorized Repairs</h3>
        <p>We fix iPhones, iPad's, Mac's and software issues with original factory parts.</p>
        <button class="btn" id="apple-begin">Start Apple Trade‑In</button>
        <div id="apple-output" style="margin-top:10px"></div>
      </div>
    </section>

    <section class="section two-col" id="lease">
      <div class="panel glow">
        <h3>Progressive Leasing</h3>
        <p>Want the newest phone without breaking the bank? Try our lease-to-own option. No credit check.</p>
        <div class="row">
          <input id="lease-name" class="chip" placeholder="Full name" />
          <input id="lease-email" class="chip" placeholder="Email address" />
        </div>
        <div class="row">
          <input id="lease-phone" class="chip" placeholder="Phone" />
          <input id="lease-zip" class="chip" placeholder="ZIP" />
          <button class="btn" id="lease-prequal">Check Pre‑Qualification</button>
        </div>
        <div id="lease-output" style="margin-top:10px"></div>
      </div>
      <div class="panel" id="internet">
        <h3>Nomad Internet: Home & Travel Unlimited</h3>
        <p>High‑speed wireless plans for home or RV. Check coverage by ZIP and activate orders.</p>
        <div class="row">
          <input id="nomad-zip" class="chip" placeholder="ZIP code" />
          <button class="btn" id="nomad-check">Check Availability</button>
        </div>
        <div id="nomad-output" style="margin-top:10px"></div>
      </div>
    </section>

    <section class="section" id="support">
      <div class="panel">
        <h3>Support</h3>
        <p>Email: info@pacmacmobile.com | 402.302.2197</p>
      </div>
    </section>

<footer>
  <div class="cols">
    <div>
      <strong>PacMac Mobile LLC | Built with Code, Coffee and Jesus.</strong><br>
      <span class="muted">Built with care.</span>
    </div>
    <ul>
      <li><a href="pacmac_terms_service.html">Terms of Service</a></li>
      <li><a href="pacmac_privacy_policy.html">Privacy Policy</a></li>
    </ul>
    <div>
      <strong>Cart</strong><br>
      Secure checkout powered on‑site (protected by red pandas)
    </div>
  </div>
</footer>

  </main>

  <!-- Cart Modal -->
  <dialog id="cart-modal" class="modal">
    <div class="hd"><div style="font-weight:600">Your Cart</div><button class="link" id="close-cart">Close</button></div>
    <div class="bd" id="cart-contents"></div>
    <div class="ft">
      <div id="cart-total" style="margin-right:auto"></div>
      <button class="btn" id="checkout">Checkout</button>
    </div>
  </dialog>

  <!-- Generic Flow Modal -->
  <dialog id="flow-modal" class="modal">
    <div class="hd"><div id="flow-title" style="font-weight:600">Flow</div><button class="link" id="flow-close">Close</button></div>
    <div class="bd" id="flow-body"></div>
    <div class="ft" id="flow-actions"></div>
  </dialog>

  <button class="btn cart-fab" id="fab-cart">🛒 <span class="count" id="cart-count">0</span></button>

  <script>
    /***** 0) Utilities *****/
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const fmt = n => new Intl.NumberFormat(undefined,{style:'currency', currency:'USD'}).format(n);

    const Store = {
      key: 'pmm-cart-v1',
      read(){ try{ return JSON.parse(localStorage.getItem(this.key)||'[]'); }catch{ return [] } },
      write(items){ localStorage.setItem(this.key, JSON.stringify(items)); updateCartUI(); },
      clear(){ localStorage.removeItem(this.key); updateCartUI(); }
    };

    /***** 1) Starfield (reactive parallax) *****/
    const starCanvas = document.getElementById('stars');
    const ctx = starCanvas.getContext('2d', { alpha: true });
    let stars = [], mouse = {x:0, y:0}, w=0, h=0, dpr = Math.min(2, window.devicePixelRatio||1);

    function resize(){ w = starCanvas.width = Math.floor(innerWidth*dpr); h = starCanvas.height = Math.floor(innerHeight*dpr); starCanvas.style.width=innerWidth+'px'; starCanvas.style.height=innerHeight+'px';
      const count = Math.floor((innerWidth*innerHeight)/1800);
      stars = Array.from({length:count}, ()=>({
        x: Math.random()*w, y: Math.random()*h, z: Math.random()*1 + .3, r: Math.random()*1.2 + .2
      }));
    }
    function draw(){ ctx.clearRect(0,0,w,h); const cx = (mouse.x*dpr - w/2)/w, cy = (mouse.y*dpr - h/2)/h; const scroll = window.scrollY/innerHeight;
      for(const s of stars){ const px = s.x + (cx*30)*(1/s.z) + scroll*12*(1/s.z); const py = s.y + (cy*30)*(1/s.z) + scroll*18*(1/s.z);
        const twinkle = (1 + Math.sin((performance.now()/600 + s.x)*s.z))*0.3;
        ctx.beginPath(); ctx.arc((px+w)%w, (py+h)%h, s.r + twinkle, 0, Math.PI*2);
        ctx.fillStyle = `rgba(${150 + s.z*80}, ${170 + s.z*50}, 255, ${.35 + .4*s.z})`;
        ctx.fill();
      }
      requestAnimationFrame(draw);
    }
    window.addEventListener('resize', resize, {passive:true});
    window.addEventListener('mousemove', e=> { mouse.x = e.clientX; mouse.y=e.clientY; }, {passive:true});
    resize(); requestAnimationFrame(draw);

    /***** 2) Minimal product catalog *****/
    const PRODUCTS = [
      {
        id:'pm-iphone15', 
        name:'iPhone 15', 
        price: 799.00, 
        tags:['5G','128GB','A16 Bionic'],
        img:'products/iPhone-15.jpg',
        description: 'Latest iPhone with USB-C, Dynamic Island, and 48MP camera',
        specs: {
          'Display': '6.1" Super Retina XDR',
          'Chip': 'A16 Bionic',
          'Storage': '128GB',
          'Camera': '48MP Main + 12MP Ultra Wide',
          'Battery': 'Up to 20 hours video playback',
          'Connectivity': '5G, Wi-Fi 6, Bluetooth 5.3',
          'Colors': 'Black, Blue, Green, Yellow, Pink'
        }
      },
      {
        id:'pm-iphone15plus', 
        name:'iPhone 15 Plus', 
        price: 899.00, 
        tags:['5G','128GB','6.7" Display'],
        img:'products/iPhone15Plus.jpg',
        description: 'Larger display with all iPhone 15 features and extended battery life',
        specs: {
          'Display': '6.7" Super Retina XDR',
          'Chip': 'A16 Bionic',
          'Storage': '128GB',
          'Camera': '48MP Main + 12MP Ultra Wide',
          'Battery': 'Up to 26 hours video playback',
          'Connectivity': '5G, Wi-Fi 6, Bluetooth 5.3',
          'Colors': 'Black, Blue, Green, Yellow, Pink'
        }
      },
      {
        id:'pm-ipad-air', 
        name:'iPad Air 11"', 
        price: 599.00, 
        tags:['Wi-Fi','M2','11" Display'],
        img:'products/iPadAir11.jpg',
        description: 'Powerful tablet with M2 chip, perfect for work and creativity',
        specs: {
          'Display': '11" Liquid Retina',
          'Chip': 'M2 with 8-core CPU',
          'Storage': '128GB',
          'Camera': '12MP Ultra Wide front camera',
          'Battery': 'Up to 10 hours',
          'Connectivity': 'Wi-Fi 6, Bluetooth 5.3',
          'Colors': 'Space Gray, Starlight, Blue, Purple, Pink'
        }
      },
      {
        id:'pm-watch10', 
        name:'Apple Watch Series 10', 
        price: 399.00, 
        tags:['GPS','Health','S9 Chip'],
        img:'products/AppleWatch10.jpg',
        description: 'Advanced health monitoring with faster performance and brighter display',
        specs: {
          'Display': 'Always-On Retina',
          'Chip': 'S9 SiP',
          'Storage': '32GB',
          'Sensors': 'Heart Rate, ECG, Blood Oxygen',
          'Battery': 'Up to 18 hours',
          'Connectivity': 'GPS, Wi-Fi, Bluetooth 5.3',
          'Colors': 'Midnight, Starlight, Silver, Red, Blue'
        }
      },
      {
        id:'pm-galaxyS25', 
        name:'Samsung Galaxy S25', 
        price: 799.00, 
        tags:['Android','AI','5G'],
        img:'products/SamS25.jpg',
        description: 'AI-powered Android flagship with advanced camera system',
        specs: {
          'Display': '6.2" Dynamic AMOLED 2X',
          'Chip': 'Snapdragon 8 Gen 4',
          'Storage': '128GB',
          'Camera': '50MP Main + 12MP Ultra Wide + 10MP Tele',
          'Battery': '4000mAh',
          'Connectivity': '5G, Wi-Fi 7, Bluetooth 5.4',
          'Colors': 'Onyx Black, Marble Gray, Cobalt Violet'
        }
      },
      {
        id:'pm-galaxyS25Ultra',
        name:'Samsung Galaxy S25 Ultra',
        price: 1199.00, 
        tags:['Android','AI','S Pen'],
        img:'products/SamS25Ultra.jpg',
        description: 'Ultimate Android experience with S Pen and 200MP camera',
        specs: {
          'Display': '6.8" Dynamic AMOLED 2X',
          'Chip': 'Snapdragon 8 Gen 4',
          'Storage': '256GB',
          'Camera': '200MP Main + 12MP Ultra Wide + 50MP Tele + 10MP Tele',
          'Battery': '5000mAh',
          'Connectivity': '5G, Wi-Fi 7, Bluetooth 5.4',
          'Colors': 'Titanium Black, Titanium Gray, Titanium Violet'
        }
      }
    ];

    // Accessories data with compatibility mapping
    const ACCESSORIES = [
      {
        id: 'acc-iphone-case',
        name: 'Silicone Case',
        price: 49.00,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><rect x="10" y="10" width="80" height="80" fill="%23ddd" stroke="%23000" stroke-width="2"/><circle cx="30" cy="30" r="8" fill="%23000"/><rect x="60" y="25" width="20" height="10" fill="%23000"/></svg>',
        compatibility: ['pm-iphone15', 'pm-iphone15plus'],
        category: 'Protection'
      },
      {
        id: 'acc-iphone-screen',
        name: 'Tempered Glass Screen Protector',
        price: 19.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><rect x="15" y="15" width="70" height="70" fill="%23fff" stroke="%23000" stroke-width="1"/><circle cx="50" cy="50" r="15" fill="%23ddd"/></svg>',
        compatibility: ['pm-iphone15', 'pm-iphone15plus', 'pm-galaxyS25', 'pm-galaxyS25ultra'],
        category: 'Protection'
      },
      {
        id: 'acc-wireless-charger',
        name: 'MagSafe Wireless Charger',
        price: 39.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><circle cx="50" cy="50" r="25" fill="%23ddd" stroke="%23000" stroke-width="2"/><circle cx="50" cy="50" r="15" fill="%23fff"/><path d="M30 50 L70 50 M50 30 L50 70" stroke="%23000" stroke-width="2"/></svg>',
        compatibility: ['pm-iphone15', 'pm-iphone15plus'],
        category: 'Charging'
      },
      {
        id: 'acc-usb-c-cable',
        name: 'USB-C to USB-C Cable',
        price: 19.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><rect x="20" y="40" width="60" height="20" fill="%23ddd" stroke="%23000" stroke-width="2"/><rect x="15" y="35" width="10" height="30" fill="%23000"/><rect x="75" y="35" width="10" height="30" fill="%23000"/></svg>',
        compatibility: ['pm-iphone15', 'pm-iphone15plus', 'pm-ipad-air'],
        category: 'Charging'
      },
      {
        id: 'acc-ipad-case',
        name: 'Smart Folio Case',
        price: 79.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><rect x="10" y="20" width="80" height="60" fill="%23ddd" stroke="%23000" stroke-width="2"/><rect x="15" y="25" width="70" height="50" fill="%23fff"/><rect x="20" y="30" width="60" height="40" fill="%23eee"/></svg>',
        compatibility: ['pm-ipad-air'],
        category: 'Protection'
      },
      {
        id: 'acc-apple-pencil',
        name: 'Apple Pencil (2nd Gen)',
        price: 129.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><rect x="35" y="20" width="30" height="60" fill="%23ddd" stroke="%23000" stroke-width="2"/><rect x="40" y="25" width="20" height="50" fill="%23fff"/><circle cx="50" cy="15" r="5" fill="%23000"/></svg>',
        compatibility: ['pm-ipad-air'],
        category: 'Accessories'
      },
      {
        id: 'acc-watch-band',
        name: 'Sport Band',
        price: 49.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><circle cx="50" cy="50" r="20" fill="%23ddd" stroke="%23000" stroke-width="2"/><rect x="20" y="45" width="20" height="10" fill="%23000"/><rect x="60" y="45" width="20" height="10" fill="%23000"/></svg>',
        compatibility: ['pm-watch10'],
        category: 'Accessories'
      },
      {
        id: 'acc-galaxy-case',
        name: 'Galaxy Protective Case',
        price: 34.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><rect x="15" y="15" width="70" height="70" fill="%23ddd" stroke="%23000" stroke-width="2"/><circle cx="35" cy="35" r="8" fill="%23000"/><rect x="55" y="30" width="25" height="10" fill="%23000"/></svg>',
        compatibility: ['pm-galaxyS25', 'pm-galaxyS25ultra'],
        category: 'Protection'
      },
      {
        id: 'acc-s-pen',
        name: 'S Pen',
        price: 59.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><rect x="40" y="20" width="20" height="60" fill="%23ddd" stroke="%23000" stroke-width="2"/><rect x="42" y="22" width="16" height="56" fill="%23fff"/><circle cx="50" cy="15" r="3" fill="%23000"/></svg>',
        compatibility: ['pm-galaxyS25ultra'],
        category: 'Accessories'
      },
      {
        id: 'acc-fast-charger',
        name: '25W Fast Charger',
        price: 29.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><rect x="30" y="30" width="40" height="40" fill="%23ddd" stroke="%23000" stroke-width="2"/><rect x="35" y="35" width="30" height="30" fill="%23fff"/><circle cx="50" cy="50" r="8" fill="%23000"/></svg>',
        compatibility: ['pm-galaxyS25', 'pm-galaxyS25ultra'],
        category: 'Charging'
      },
      {
        id: 'acc-bluetooth-earbuds',
        name: 'Wireless Earbuds',
        price: 89.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><circle cx="30" cy="50" r="12" fill="%23ddd" stroke="%23000" stroke-width="2"/><circle cx="70" cy="50" r="12" fill="%23ddd" stroke="%23000" stroke-width="2"/><rect x="35" y="48" width="30" height="4" fill="%23000"/></svg>',
        compatibility: ['pm-iphone15', 'pm-iphone15plus', 'pm-ipad-air', 'pm-galaxyS25', 'pm-galaxyS25ultra'],
        category: 'Audio'
      },
      {
        id: 'acc-power-bank',
        name: '10,000mAh Power Bank',
        price: 39.99,
        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f0f0f0"/><rect x="20" y="25" width="60" height="50" fill="%23ddd" stroke="%23000" stroke-width="2"/><rect x="25" y="30" width="50" height="40" fill="%23fff"/><rect x="30" y="35" width="40" height="30" fill="%23eee"/><circle cx="50" cy="50" r="8" fill="%23000"/></svg>',
        compatibility: ['pm-iphone15', 'pm-iphone15plus', 'pm-ipad-air', 'pm-galaxyS25', 'pm-galaxyS25ultra'],
        category: 'Charging'
      }
    ];

    const grid = document.getElementById('product-grid');
    for(const p of PRODUCTS){
      const el = document.createElement('article');
      el.className='card';
      el.setAttribute('role','listitem');
      
      // Create front of card
      const frontContent = `
        <div class="card-front">
          <div class="flip-indicator">Click to see specs</div>
          <div class="img" aria-hidden="true"><img src="${p.img}" alt="${p.name}" style="max-width:100%; height:auto; border-radius:8px;" /></div>
          <h3>${p.name}</h3>
          <p style="color:var(--muted); font-size:14px; margin:0 14px 8px;">${p.description}</p>
          <p>${p.tags.map(t=>`<span class="chip">${t}</span>`).join(' ')}</p>
                  <div class="price-row">
          <div><strong>${fmt(p.price)}</strong></div>
          <div style="display: flex; gap: 8px;">
            <button class="btn" style="background: var(--accent-2); color: #000; font-size: 12px; padding: 8px 12px;" onclick="showTradeInPrompt(${JSON.stringify(p).replace(/"/g, '&quot;')})">Trade In</button>
            <button class="btn" data-id="${p.id}">Add to Cart</button>
          </div>
        </div>
        </div>
      `;
      
      // Create back of card with specifications
      const specsList = Object.entries(p.specs).map(([key, value]) => 
        `<li><span class="specs-label">${key}</span><span class="specs-value">${value}</span></li>`
      ).join('');
      
      const backContent = `
        <div class="card-back">
          <div>
            <h3 style="margin:0 0 12px 0; color:var(--accent);">${p.name} Specifications</h3>
            <ul class="specs-list">
              ${specsList}
            </ul>
          </div>
          <div style="text-align:center; margin-top:16px;">
            <button class="btn" data-id="${p.id}" style="width:100%;">Add to Cart - ${fmt(p.price)}</button>
          </div>
        </div>
      `;
      
      el.innerHTML = frontContent + backContent;
      
      // Add click event for card flip
      el.addEventListener('click', (e) => {
        // Don't flip if clicking the Add to Cart button
        if (e.target.classList.contains('btn')) {
          addToCart(p);
          return;
        }
        el.classList.toggle('flipped');
      });
      
      // Add to cart button events
      $$('button[data-id]', el).forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent card flip
          addToCart(p);
        });
      });
      
      grid.appendChild(el);
    }

    /***** 3) Cart *****/
    const cartBtn = document.getElementById('open-cart');
    const cartFab = document.getElementById('fab-cart');
    const cartCount = document.getElementById('cart-count');
    const cartModal = document.getElementById('cart-modal');
    const cartContents = document.getElementById('cart-contents');
    const cartTotal = document.getElementById('cart-total');
    const closeCart = document.getElementById('close-cart');
    const checkout = document.getElementById('checkout');

    cartBtn.addEventListener('click', ()=> cartModal.showModal());
    cartFab.addEventListener('click', ()=> cartModal.showModal());
    closeCart.addEventListener('click', ()=> cartModal.close());

    function readCart(){ return Store.read(); }
    function addToCart(p){ 
      const items = readCart(); 
      const found = items.find(i=>i.id===p.id); 
      if(found) found.qty++; 
      else items.push({...p, qty:1}); 
      Store.write(items); 
      pulseCount(); 
      
      // Show add to cart animation
      showAddToCartAnimation();
      
      // Show trade-in prompt after a short delay
      setTimeout(() => {
        showTradeInPrompt(p);
      }, 800);
      
              // Show accessories after trade-in prompt
        setTimeout(() => {
          showAccessoriesForProduct(p);
        }, 3000);
        
        // Add event listener for Nomad add-on checkbox
        document.addEventListener('DOMContentLoaded', function() {
          const nomadCheckbox = document.getElementById('nomad-addon');
          if (nomadCheckbox) {
            nomadCheckbox.addEventListener('change', updateCheckoutWithNomad);
          }
        });
    }
    
    function showAddToCartAnimation() {
      const animation = document.createElement('div');
      animation.className = 'add-to-cart-animation';
      animation.textContent = 'Added to Cart! 🛒';
      document.body.appendChild(animation);
      
      // Remove animation element after animation completes
      setTimeout(() => {
        document.body.removeChild(animation);
      }, 800);
    }
    
    function showAccessoriesForProduct(product) {
      // Hide product grid
      const productGrid = document.getElementById('product-grid');
      const accessoriesSection = document.getElementById('accessories-section');
      
      productGrid.style.display = 'none';
      
      // Update accessories section title
      document.getElementById('accessories-title').textContent = `Accessories for ${product.name}`;
      document.getElementById('accessories-subtitle').textContent = `Enhance your ${product.name} with these compatible accessories`;
      
      // Filter accessories for this product
      const compatibleAccessories = ACCESSORIES.filter(acc => 
        acc.compatibility.includes(product.id)
      );
      
      // Render accessories
      const accessoriesGrid = document.getElementById('accessories-grid');
      accessoriesGrid.innerHTML = '';
      
      compatibleAccessories.forEach(acc => {
        const accCard = document.createElement('div');
        accCard.className = 'accessory-card';
        accCard.innerHTML = `
          <img src="${acc.image}" alt="${acc.name}" />
          <h4>${acc.name}</h4>
          <div class="price">${fmt(acc.price)}</div>
          <div class="compatibility">Compatible with ${product.name}</div>
          <button class="btn" data-acc-id="${acc.id}">Add to Cart</button>
        `;
        
        // Add to cart functionality for accessories
        const addButton = accCard.querySelector('button');
        addButton.addEventListener('click', () => {
          const accItems = readCart();
          const found = accItems.find(i => i.id === acc.id);
          if (found) found.qty++;
          else accItems.push({...acc, qty: 1});
          Store.write(accItems);
          pulseCount();
          showAddToCartAnimation();
        });
        
        accessoriesGrid.appendChild(accCard);
      });
      
      // Show accessories section
      accessoriesSection.classList.add('active');
      
      // Scroll to accessories section
      accessoriesSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    function showProducts() {
      const productGrid = document.getElementById('product-grid');
      const accessoriesSection = document.getElementById('accessories-section');
      
      productGrid.style.display = 'grid';
      accessoriesSection.classList.remove('active');
    }
    function removeFromCart(id){ const items = readCart().filter(i=>i.id!==id); Store.write(items); }
    function changeQty(id, delta){ const items = readCart(); const it = items.find(i=>i.id===id); if(!it) return; it.qty = Math.max(1, it.qty+delta); Store.write(items); }

    function updateCartUI(){ const items = readCart(); cartCount.textContent = items.reduce((s,i)=>s+i.qty,0);
      cartContents.innerHTML = items.length? '' : '<p>Your cart is empty.</p>';
      let sum=0;
      for(const i of items){ sum += i.price*i.qty; const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between'; row.style.borderBottom='1px solid #161616'; row.style.padding='8px 0';
        row.innerHTML = `<div><strong>${i.name}</strong><br><span class="chip">${fmt(i.price)} × ${i.qty}</span></div>
          <div class="row"><button class="btn" data-act="dec">−</button><button class="btn" data-act="inc">+</button><button class="btn" data-act="rm">Remove</button></div>`;
        row.querySelector('[data-act="dec"]').onclick=()=>changeQty(i.id,-1);
        row.querySelector('[data-act="inc"]').onclick=()=>changeQty(i.id,1);
        row.querySelector('[data-act="rm"]').onclick=()=>removeFromCart(i.id);
        cartContents.appendChild(row);
      }
      cartTotal.textContent = 'Total: ' + fmt(sum);
    }
    function pulseCount(){ cartFab.classList.add('pulse'); setTimeout(()=>cartFab.classList.remove('pulse'), 1200) }
    updateCartUI();

    checkout.addEventListener('click', ()=>{
      const items = readCart(); if(!items.length){ alert('Cart is empty'); return; }
      openFlow({
        title: 'Checkout',
        body: renderCheckout(items),
        actions: [
          {label:'Pay Now', handler: completeCheckout},
          {label:'Lease with Progressive', handler: ()=> ProgressiveLeasing.startFromCart(items) },
        ]
      });
    });

    function renderCheckout(items){ 
      const sum = items.reduce((s,i)=>s+i.price*i.qty,0);
      const tax = sum * 0.07; // 7% tax
      const total = sum + tax;
      
      return `<div>
        <p>Choose your preferred payment method. All options are secure and encrypted.</p>
        
        <!-- Payment Method Selection -->
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 12px; font-weight: 600; font-size: 16px;">Payment Method</label>
          <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <label style="flex: 1; cursor: pointer;">
              <input type="radio" name="payment-method" value="card" checked style="margin-right: 8px;">
              <span style="display: inline-block; padding: 12px; border: 2px solid #161616; border-radius: 8px; background: #0a0a0a; width: 100%; text-align: center; transition: all 0.2s;" id="card-option">
                💳 Credit/Debit Card
              </span>
            </label>
            <label style="flex: 1; cursor: pointer;">
              <input type="radio" name="payment-method" value="progressive" style="margin-right: 8px;">
              <span style="display: inline-block; padding: 12px; border: 2px solid #161616; border-radius: 8px; background: #0a0a0a; width: 100%; text-align: center; transition: all 0.2s;" id="progressive-option">
                📋 Progressive Leasing
              </span>
            </label>
          </div>
        </div>
        
        <!-- Order Summary -->
        <div style="margin: 20px 0; padding: 16px; background: #0a0a0a; border-radius: 12px; border: 1px solid #161616;">
          <h4 style="margin: 0 0 12px 0;">Order Summary</h4>
          <div style="display: flex; justify-content: space-between; margin: 4px 0;">
            <span>Subtotal:</span>
            <span>${fmt(sum)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 4px 0;">
            <span>Tax (7%):</span>
            <span>${fmt(tax)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 8px 0; padding-top: 8px; border-top: 1px solid #161616; font-weight: bold;">
            <span>Total:</span>
            <span>${fmt(total)}</span>
          </div>
          
          <!-- Trade-in Savings Section -->
          <div style="margin-top: 16px; padding: 12px; background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); border-radius: 8px; border: 1px solid #161616;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-size: 14px; color: var(--accent-2);">💡 Save with Trade-In</span>
              <button class="btn" style="background: var(--accent-2); color: #000; font-size: 12px; padding: 6px 12px;" onclick="showTradeInPrompt({name: 'your device', id: 'checkout-trade-in'})">Trade In Now</button>
            </div>
            <p style="margin: 0; font-size: 12px; color: var(--muted);">
              Trade in your old device and save up to ${fmt(total * 0.6)} on your purchase. 
              <a href="https://apidocs.phobio.com" target="_blank" style="color: var(--accent); text-decoration: underline;">Learn more</a>
            </p>
          </div>
          
          <!-- Nomad Internet Add-On Section -->
          <div style="margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #1a0a1a 0%, #2a1a2a 100%); border-radius: 12px; border: 2px solid var(--accent-2); position: relative; overflow: hidden;">
            <!-- Special Offer Badge -->
            <div style="position: absolute; top: -8px; right: -8px; background: var(--accent-2); color: #000; padding: 4px 12px; border-radius: 12px; font-size: 10px; font-weight: bold; transform: rotate(15deg);">
              SPECIAL OFFER
            </div>
            
            <div style="display: flex; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 24px; margin-right: 12px;">🌐</div>
              <div>
                <h4 style="margin: 0 0 4px 0; color: var(--accent-2);">Nomad Internet</h4>
                <p style="margin: 0; font-size: 14px; color: var(--muted);">Unlimited Wireless Internet</p>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-bottom: 12px;">
              <div>
                <div style="display: flex; align-items: center; margin-bottom: 4px;">
                  <span style="text-decoration: line-through; color: var(--muted); font-size: 14px;">$59.95/mo</span>
                  <span style="margin-left: 8px; background: var(--accent-2); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;">SAVE 20%</span>
                </div>
                <div style="font-size: 18px; font-weight: bold; color: var(--accent-2);">$47.96/mo</div>
                <div style="font-size: 12px; color: var(--muted);">+ FREE Modem Included</div>
              </div>
              <div style="text-align: right;">
                <label class="checkbox-container" style="margin: 0;">
                  <input type="checkbox" id="nomad-addon" style="margin-right: 8px;">
                  <span style="font-size: 12px; color: var(--muted);">Add to Order</span>
                </label>
              </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; margin-bottom: 12px;">
              <div style="font-size: 12px; color: var(--accent-2); font-weight: 500; margin-bottom: 4px;">✨ What's Included:</div>
              <ul style="margin: 0; padding-left: 16px; font-size: 11px; color: var(--muted);">
                <li>Unlimited data with no throttling</li>
                <li>14-day risk-free trial</li>
                <li>Easy self-installation</li>
                <li>No contracts, cancel anytime</li>
                <li>Coverage in your area</li>
              </ul>
            </div>
            
            <div style="display: flex; gap: 8px;">
              <button class="btn" style="background: transparent; border: 1px solid var(--accent-2); color: var(--accent-2); font-size: 12px; padding: 8px 12px; flex: 1;" onclick="window.open('https://bit.ly/3IN8z0d', '_blank')">
                Learn More
              </button>
              <button class="btn" style="background: var(--accent-2); color: #000; font-size: 12px; padding: 8px 12px; flex: 1;" onclick="addNomadToOrder()">
                Add Internet
              </button>
            </div>
          </div>
        </div>
        
        <!-- Credit Card Payment Form -->
        <div id="card-payment-form" style="margin: 20px 0;">
          <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email Address</label>
            <input id="checkout-email" class="chip" placeholder="your@email.com" style="width: 100%; margin-bottom: 12px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Phone Number</label>
            <input id="checkout-phone" class="chip" placeholder="(402) 555-0123" style="width: 100%; margin-bottom: 12px;">
          </div>
          <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Card Information</label>
            <div class='row' style="gap: 8px;">
              <input id="checkout-card" class="chip" placeholder="1234 5678 9012 3456" style="flex: 2;">
              <input id="checkout-expiry" class="chip" placeholder="MM/YY" style="flex: 1;">
              <input id="checkout-cvc" class="chip" placeholder="CVC" style="flex: 1;">
            </div>
          </div>
          <div style="margin: 20px 0; padding: 12px; background: #0a0a0a; border-radius: 8px; border: 1px solid #161616; font-size: 14px; color: var(--muted);">
            <strong>🔒 Secure Checkout:</strong> Your payment information is encrypted and processed securely by Stripe. We never store your card details.
          </div>
        </div>
        
        <!-- Progressive Leasing Form -->
        <div id="progressive-payment-form" style="margin: 20px 0; display: none;">
          <div style="margin: 20px 0; padding: 16px; background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); border-radius: 12px; border: 1px solid #161616;">
            <h4 style="margin: 0 0 12px 0; color: var(--accent);">📋 Progressive Leasing Application</h4>
            <p style="margin: 0 0 16px 0; color: var(--muted); font-size: 14px;">
              Progressive Leasing offers flexible lease-to-own options with no credit check required. 
              <a href="https://developers.progleasing.com/docs/before-you-begin" target="_blank" style="color: var(--accent); text-decoration: underline;">Learn more about Progressive Leasing</a>
            </p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">First Name</label>
                <input id="prog-first-name" class="chip" placeholder="John" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Last Name</label>
                <input id="prog-last-name" class="chip" placeholder="Doe" style="width: 100%;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Email Address</label>
                <input id="prog-email" class="chip" placeholder="john@example.com" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Phone Number</label>
                <input id="prog-phone" class="chip" placeholder="(402) 555-0123" style="width: 100%;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">ZIP Code</label>
                <input id="prog-zip" class="chip" placeholder="68102" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">Date of Birth</label>
                <input id="prog-dob" class="chip" placeholder="MM/DD/YYYY" style="width: 100%;">
              </div>
            </div>
            
            <div style="margin: 16px 0; padding: 12px; background: #0a0a0a; border-radius: 8px; border: 1px solid #161616; font-size: 14px;">
              <h5 style="margin: 0 0 8px 0; color: var(--accent-2);">Lease Terms Preview</h5>
              <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                <span>Lease Amount:</span>
                <span>${fmt(total)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                <span>Estimated Monthly Payment:</span>
                <span>${fmt(Math.round(total / 12))}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                <span>Term Length:</span>
                <span>12 months</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 8px 0; padding-top: 8px; border-top: 1px solid #161616; font-weight: bold;">
                <span>Total Cost of Ownership:</span>
                <span>${fmt(total * 1.2)}</span>
              </div>
            </div>
            
            <div style="margin: 16px 0; padding: 12px; background: #0a0a0a; border-radius: 8px; border: 1px solid #161616; font-size: 12px; color: var(--muted);">
              <strong>ℹ️ Important Information:</strong> Progressive Leasing is a lease-to-own program. You will own the merchandise after making all payments. This is not a credit transaction. Additional fees may apply. See <a href="https://developers.progleasing.com/docs/before-you-begin" target="_blank" style="color: var(--accent);">Progressive Leasing terms</a> for complete details.
            </div>
          </div>
        </div>
      </div>`;
    }
    
    async function completeCheckout(){ 
      const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
      
      if (paymentMethod === 'card') {
        await processCardPayment();
      } else if (paymentMethod === 'progressive') {
        await processProgressiveLeasing();
      }
    }
    
    async function processCardPayment() {
      const email = $('#checkout-email').value;
      const phone = $('#checkout-phone').value;
      const card = $('#checkout-card').value;
      const expiry = $('#checkout-expiry').value;
      const cvc = $('#checkout-cvc').value;
      
      // Basic validation
      if (!email || !phone || !card || !expiry || !cvc) {
        alert('Please fill in all required fields.');
        return;
      }
      
      if (!PMM_UTILS.validateEmail(email)) {
        alert('Please enter a valid email address.');
        return;
      }
      
      const items = readCart();
      const sum = items.reduce((s,i)=>s+i.price*i.qty,0);
      const tax = sum * 0.07;
      const total = sum + tax;
      
      // Process payment
      const paymentResult = await PMM_UTILS.processPayment(total, 'demo_token', `PacMac Mobile Order - ${items.length} items`);
      
      if (paymentResult.success) {
        const orderId = PMM_UTILS.generateOrderId();
        
        // Check if Nomad add-on was selected
        const nomadAddon = sessionStorage.getItem('nomadAddon');
        let emailHtml = `<h2>Order Confirmed!</h2>
           <p>Thank you for your order with PacMac Mobile.</p>
           <p><strong>Order ID:</strong> ${orderId}</p>
           <p><strong>Payment Method:</strong> Credit/Debit Card</p>
           <p><strong>Total:</strong> ${PMM_UTILS.formatPrice(total)}</p>
           <p>We'll ship your items within 1-2 business days and send you tracking information.</p>
           <p>Questions? Call us at 402.302.2197 or email info@pacmacmobile.com</p>`;
        
        let emailText = `Order Confirmed!\n\nOrder ID: ${orderId}\nPayment Method: Credit/Debit Card\nTotal: ${PMM_UTILS.formatPrice(total)}\n\nWe'll ship your items within 1-2 business days.`;
        
        if (nomadAddon) {
          const nomadItem = JSON.parse(nomadAddon);
          emailHtml += `
           <div style="margin-top: 20px; padding: 16px; background: #f0f0f0; border-radius: 8px;">
             <h3>🌐 Nomad Internet Add-On</h3>
             <p>You've added Nomad Internet to your order!</p>
             <p><strong>Service:</strong> ${nomadItem.name}</p>
             <p><strong>Monthly Cost:</strong> $${nomadItem.price}</p>
             <p><strong>Next Steps:</strong></p>
             <ol>
               <li>Complete your Nomad Internet setup at <a href="https://bit.ly/3IN8z0d" style="color: #007bff;">Nomad Internet</a></li>
               <li>Enter your address to check coverage</li>
               <li>Start your 14-day risk-free trial</li>
               <li>Enjoy unlimited wireless internet!</li>
             </ol>
             <p style="margin-top: 12px; font-size: 14px; color: #666;">
               <strong>Special Offer:</strong> You're getting 20% off the regular price of $59.95/mo!
             </p>
           </div>`;
          
          emailText += `\n\n🌐 Nomad Internet Add-On\nService: ${nomadItem.name}\nMonthly Cost: $${nomadItem.price}\nNext Steps: Visit https://bit.ly/3IN8z0d to complete setup\nSpecial Offer: 20% off regular price!`;
          
          // Clear the session storage
          sessionStorage.removeItem('nomadAddon');
        }
        
        // Send order confirmation email
        await PMM_UTILS.sendEmail(
          email,
          'Order Confirmed - PacMac Mobile',
          emailHtml,
          emailText
        );
        
        alert(`Order confirmed! Order ID: ${orderId}\nCheck your email for confirmation.`);
        $('#flow-modal').close(); 
        Store.clear(); 
        updateCartUI(); 
        cartModal.close();
      } else {
        alert('Payment failed. Please check your card information and try again.');
      }
    }
    
    async function processProgressiveLeasing() {
      const firstName = $('#prog-first-name').value;
      const lastName = $('#prog-last-name').value;
      const email = $('#prog-email').value;
      const phone = $('#prog-phone').value;
      const zip = $('#prog-zip').value;
      const dob = $('#prog-dob').value;
      
      // Basic validation
      if (!firstName || !lastName || !email || !phone || !zip || !dob) {
        alert('Please fill in all required fields for Progressive Leasing application.');
        return;
      }
      
      if (!PMM_UTILS.validateEmail(email)) {
        alert('Please enter a valid email address.');
        return;
      }
      
      if (!PMM_UTILS.validateZip(zip)) {
        alert('Please enter a valid ZIP code.');
        return;
      }
      
      const items = readCart();
      const sum = items.reduce((s,i)=>s+i.price*i.qty,0);
      const tax = sum * 0.07;
      const total = sum + tax;
      
      // Process Progressive Leasing application
      const leaseResult = await PMM_PROGRESSIVE.startLease(items, {
        name: `${firstName} ${lastName}`,
        email: email,
        phone: phone,
        zip: zip,
        dob: dob,
        amount: total
      });
      
      if (leaseResult.status === 'approved') {
        const orderId = PMM_UTILS.generateOrderId();
        
        // Check if Nomad add-on was selected
        const nomadAddon = sessionStorage.getItem('nomadAddon');
        let emailHtml = `<h2>Lease Application Approved!</h2>
           <p>Congratulations! Your Progressive Leasing application has been approved.</p>
           <p><strong>Order ID:</strong> ${orderId}</p>
           <p><strong>Lease ID:</strong> ${leaseResult.id}</p>
           <p><strong>Credit Limit:</strong> ${PMM_UTILS.formatPrice(leaseResult.limit)}</p>
           <p><strong>Monthly Payment:</strong> ${PMM_UTILS.formatPrice(leaseResult.monthlyPayment)}</p>
           <p><strong>Terms:</strong> ${leaseResult.terms}</p>
           <p>We'll contact you within 24 hours to complete your order and arrange delivery.</p>
           <p>Questions? Call us at 402.302.2197 or email info@pacmacmobile.com</p>
           <p><small>Progressive Leasing is a lease-to-own program. You will own the merchandise after making all payments. This is not a credit transaction. Additional fees may apply.</small></p>`;
        
        let emailText = `Lease Application Approved!\n\nOrder ID: ${orderId}\nLease ID: ${leaseResult.id}\nCredit Limit: ${PMM_UTILS.formatPrice(leaseResult.limit)}\nMonthly Payment: ${PMM_UTILS.formatPrice(leaseResult.monthlyPayment)}\nTerms: ${leaseResult.terms}\n\nWe'll contact you within 24 hours to complete your order.`;
        
        if (nomadAddon) {
          const nomadItem = JSON.parse(nomadAddon);
          emailHtml += `
           <div style="margin-top: 20px; padding: 16px; background: #f0f0f0; border-radius: 8px;">
             <h3>🌐 Nomad Internet Add-On</h3>
             <p>You've added Nomad Internet to your order!</p>
             <p><strong>Service:</strong> ${nomadItem.name}</p>
             <p><strong>Monthly Cost:</strong> $${nomadItem.price}</p>
             <p><strong>Next Steps:</strong></p>
             <ol>
               <li>Complete your Nomad Internet setup at <a href="https://bit.ly/3IN8z0d" style="color: #007bff;">Nomad Internet</a></li>
               <li>Enter your address to check coverage</li>
               <li>Start your 14-day risk-free trial</li>
               <li>Enjoy unlimited wireless internet!</li>
             </ol>
             <p style="margin-top: 12px; font-size: 14px; color: #666;">
               <strong>Special Offer:</strong> You're getting 20% off the regular price of $59.95/mo!
             </p>
           </div>`;
          
          emailText += `\n\n🌐 Nomad Internet Add-On\nService: ${nomadItem.name}\nMonthly Cost: $${nomadItem.price}\nNext Steps: Visit https://bit.ly/3IN8z0d to complete setup\nSpecial Offer: 20% off regular price!`;
          
          // Clear the session storage
          sessionStorage.removeItem('nomadAddon');
        }
        
        // Send lease approval email
        await PMM_UTILS.sendEmail(
          email,
          'Progressive Leasing Approved - PacMac Mobile',
          emailHtml,
          emailText
        );
        
        alert(`Lease application approved!\nOrder ID: ${orderId}\nLease ID: ${leaseResult.id}\nCheck your email for complete details.`);
        $('#flow-modal').close(); 
        Store.clear(); 
        updateCartUI(); 
        cartModal.close();
      } else {
        alert(`Lease application not approved: ${leaseResult.reason}\n\nPlease try a different payment method or contact us for assistance.`);
      }
    }

    /***** 4) Plugin surfaces (Adapters) *****/
    // Each provider exposes a predictable interface. Swap the internals with real API calls.
    // Set your real credentials in the CONFIG object and replace fetch mocks with live endpoints.
    const CONFIG = {
      phobio: {
        // TODO: Replace with real endpoint & auth once provisioned by Phobio
        endpoint: 'https://api.phobio.example/quote', apiKey: 'PHOBIO_API_KEY'
      },
      progressive: {
        // TODO: Replace with Progressive Leasing partner API
        endpoint: 'https://api.progressiveleasing.example', partnerId: 'PROG_PARTNER_ID'
      },
      appleTradeIn: {
        // Typically facilitated via an approved aggregator (often Phobio) or Apple programs
        endpoint: 'https://api.appletradein.example', merchantId: 'APPLE_TRADE_MERCHANT_ID'
      },
      nomad: {
        // TODO: Replace with Nomad Internet partner API
        endpoint: 'https://api.nomadinternet.example', resellerId: 'NOMAD_PARTNER_ID'
      }
    };

    // ---- Enhanced Phobio Adapter ----
    const Phobio = {
      async quote(model, condition){
        // Use enhanced trade-in pricing
        const quote = await PMM_TRADE_IN.getQuote(model, condition);
        return quote;
      },
      async submit(details){ 
        const result = await PMM_TRADE_IN.submitTradeIn(details);
        return result;
      }
    };

    // ---- Apple Authorized Trade‑In Adapter (placeholder) ----
    const AppleTradeIn = {
      async start(model){ await sleep(600); return { status:'started', steps:['Package device','Ship with label','Receive credit'], ref:'APL-'+Math.random().toString(36).slice(2,8) } },
      async quote(model){ await sleep(500); return { amount: Math.round(450*(Math.random()*0.25+.75)), currency:'USD' } }
    };

    // ---- Enhanced Progressive Leasing Adapter ----
    const ProgressiveLeasing = {
      async prequalify({name, phone, zip, amount}){
        const result = await PMM_PROGRESSIVE.prequalify({name, phone, zip, amount});
        return result;
      },
      async startFromCart(items){ 
        const sum = items.reduce((s,i)=>s+i.price*i.qty,0); 
        const name = $('#lease-name').value || 'Customer';
        const phone = $('#lease-phone').value || ''; 
        const zip = $('#lease-zip').value || '';
        const email = $('#lease-email')?.value || 'customer@pacmacmobile.com';
        
        const result = await PMM_PROGRESSIVE.startLease(items, {name, phone, zip, email, amount: sum});
        openFlow({ 
          title:'Progressive Leasing', 
          body: renderJSON(result), 
          actions:[ {label:'Close', handler: closeFlow} ] 
        });
      }
    };

    // ---- Enhanced Nomad Internet Adapter ----
    const Nomad = {
      async availability(zip){ 
        const result = await PMM_NOMAD.checkAvailability(zip);
        return result;
      },
      async order(planId, customer){ 
        const result = await PMM_NOMAD.placeOrder(planId, customer);
        return result;
      }
    };

    window.PMMPlugins = { Phobio, ProgressiveLeasing, AppleTradeIn, Nomad }; // exposed globally for easy swapping

    /***** 5) Wire up flows *****/
    const flowModal = document.getElementById('flow-modal');
    const flowTitle = document.getElementById('flow-title');
    const flowBody = document.getElementById('flow-body');
    const flowActions = document.getElementById('flow-actions');
    document.getElementById('flow-close').addEventListener('click', closeFlow);

    function openFlow({title, body, actions=[]}){
      flowTitle.textContent = title; flowBody.innerHTML = body; flowActions.innerHTML='';
      for(const a of actions){ const b=document.createElement('button'); b.className='btn'; b.textContent=a.label; b.addEventListener('click', a.handler); flowActions.appendChild(b); }
      flowModal.showModal();
    }
    function closeFlow(){ flowModal.close(); }

    // Enhanced Phobio UI
    $('#phobio-get-quote').addEventListener('click', async ()=>{
      const model = $('#phobio-model').value.trim() || 'iPhone';
      const cond = $('#phobio-cond').value;
      $('#phobio-output').textContent = 'Fetching quote…';
      const q = await Phobio.quote(model, cond);
      $('#phobio-output').innerHTML = `
        <div style="background: #0a0a0a; padding: 16px; border-radius: 12px; border: 1px solid #161616; margin: 12px 0;">
          <h4 style="margin: 0 0 12px 0;">Trade-In Quote</h4>
          <div style="display: flex; justify-content: space-between; margin: 8px 0;">
            <span>Device:</span>
            <span><strong>${model}</strong></span>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 8px 0;">
            <span>Condition:</span>
            <span>${cond}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 8px 0; padding-top: 8px; border-top: 1px solid #161616; font-weight: bold;">
            <span>Estimated Value:</span>
            <span style="color: var(--accent);">${PMM_UTILS.formatPrice(q.amount)}</span>
          </div>
          <div style="margin-top: 12px; font-size: 14px; color: var(--muted);">
            Quote valid until: ${q.validUntil.toLocaleDateString()}
          </div>
        </div>
        <div style="margin-top: 12px;">
          <input id="phobio-email" class="chip" placeholder="Your email address" style="width: 100%; margin-bottom: 8px;">
          <button class="btn" id="phobio-submit" style="width: 100%;">Submit Trade‑In</button>
        </div>`;
      $('#phobio-submit').onclick = async ()=>{
        const email = $('#phobio-email').value;
        if (!email || !PMM_UTILS.validateEmail(email)) {
          alert('Please enter a valid email address.');
          return;
        }
        const res = await Phobio.submit({model, cond, quote:q, email});
        alert(`Trade-in submitted successfully!\nOrder ID: ${res.id}\nCheck your email for confirmation.`);
        $('#phobio-output').innerHTML = '<p style="color: var(--accent);">✅ Trade-in submitted! Check your email for next steps.</p>';
      };
    });
    
    // Trade-in prompt system
    function showTradeInPrompt(product) {
      const promptModal = document.createElement('dialog');
      promptModal.className = 'modal';
      promptModal.innerHTML = `
        <div class="hd">
          <div style="font-weight:600">Trade In Your Old Device</div>
          <button class="link" onclick="this.closest('dialog').close()">Close</button>
        </div>
        <div class="bd">
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">📱</div>
            <h3 style="margin: 0 0 8px 0;">Get Credit for Your Old Device</h3>
            <p style="color: var(--muted); margin: 0;">Trade in your old device and save on your new ${product.name}</p>
          </div>
          
          <div style="background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); padding: 20px; border-radius: 12px; border: 1px solid #161616; margin-bottom: 20px;">
            <h4 style="margin: 0 0 12px 0; color: var(--accent);">How It Works</h4>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
              <div>
                <div style="font-size: 24px; margin-bottom: 8px;">1️⃣</div>
                <div style="font-size: 14px; font-weight: 500;">Get Instant Quote</div>
                <div style="font-size: 12px; color: var(--muted);">Tell us about your device</div>
              </div>
              <div>
                <div style="font-size: 24px; margin-bottom: 8px;">2️⃣</div>
                <div style="font-size: 14px; font-weight: 500;">Ship Your Device</div>
                <div style="font-size: 12px; color: var(--muted);">Free shipping label provided</div>
              </div>
              <div>
                <div style="font-size: 24px; margin-bottom: 8px;">3️⃣</div>
                <div style="font-size: 14px; font-weight: 500;">Get Your Credit</div>
                <div style="font-size: 12px; color: var(--muted);">Apply to your new purchase</div>
              </div>
            </div>
          </div>
          
          <div style="background: #0a0a0a; padding: 16px; border-radius: 12px; border: 1px solid #161616; margin-bottom: 20px;">
            <h4 style="margin: 0 0 12px 0;">Estimated Trade-In Values</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 14px;">
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #161616;">
                <span>iPhone 13 (Good):</span>
                <span style="color: var(--accent); font-weight: 600;">$450</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #161616;">
                <span>iPhone 12 (Good):</span>
                <span style="color: var(--accent); font-weight: 600;">$350</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #161616;">
                <span>iPhone 11 (Good):</span>
                <span style="color: var(--accent); font-weight: 600;">$250</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #161616;">
                <span>iPad Air (Good):</span>
                <span style="color: var(--accent); font-weight: 600;">$400</span>
              </div>
            </div>
            <p style="margin: 12px 0 0 0; font-size: 12px; color: var(--muted);">
              * Values are estimates. Final value determined after device inspection.
            </p>
          </div>
          
          <div style="background: #0a0a0a; padding: 16px; border-radius: 12px; border: 1px solid #161616; margin-bottom: 20px;">
            <h4 style="margin: 0 0 12px 0;">Why Trade In?</h4>
            <ul style="margin: 0; padding-left: 20px; color: var(--muted);">
              <li>Instant credit toward your new device</li>
              <li>Free shipping and handling</li>
              <li>Secure data wiping included</li>
              <li>Environmentally responsible disposal</li>
              <li>No hassle, no hidden fees</li>
            </ul>
          </div>
          
          <div style="margin: 16px 0; padding: 12px; background: #0a0a0a; border-radius: 8px; border: 1px solid #161616; font-size: 12px; color: var(--muted);">
            <strong>ℹ️ Powered by Phobio:</strong> Our trade-in program is powered by <a href="https://apidocs.phobio.com" target="_blank" style="color: var(--accent); text-decoration: underline;">Phobio's industry-leading trade-in platform</a>, ensuring you get the best value for your device with secure, reliable service.
          </div>
        </div>
        <div class="ft">
          <button class="btn" onclick="this.closest('dialog').close()">Maybe Later</button>
          <button class="btn" style="background: var(--accent); color: #000;" onclick="startTradeIn('${product.id}'); this.closest('dialog').close()">Start Trade-In</button>
        </div>
      `;
      
      document.body.appendChild(promptModal);
      promptModal.showModal();
      
      // Remove modal when closed
      promptModal.addEventListener('close', () => {
        document.body.removeChild(promptModal);
      });
    }
    
    function startTradeIn(productId) {
      // Scroll to trade-in section and pre-fill with product info
      const product = PRODUCTS.find(p => p.id === productId);
      if (product) {
        document.getElementById('phobio-model').value = product.name;
        document.getElementById('tradein').scrollIntoView({ behavior: 'smooth' });
        
        // Show a helpful message
        setTimeout(() => {
          $('#phobio-output').innerHTML = `
            <div style="background: var(--accent); color: #000; padding: 12px; border-radius: 8px; margin: 12px 0;">
              <strong>Ready to trade in your old device?</strong><br>
              We've pre-filled the form with "${product.name}". Just select the condition and get your instant quote!
            </div>
          `;
        }, 500);
      }
    }
    
    // Nomad Internet Add-On Functions
    function addNomadToOrder() {
      const nomadAddon = document.getElementById('nomad-addon');
      if (nomadAddon) {
        nomadAddon.checked = true;
        nomadAddon.dispatchEvent(new Event('change'));
      }
      
      // Show confirmation message
      const confirmation = document.createElement('div');
      confirmation.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--accent-2);
        color: #000;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
      `;
      confirmation.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
          <div style="font-size: 20px; margin-right: 8px;">🌐</div>
          <strong>Nomad Internet Added!</strong>
        </div>
        <div style="font-size: 14px; margin-bottom: 8px;">
          Unlimited wireless internet for $47.96/mo
        </div>
        <div style="font-size: 12px; color: #666;">
          You'll be redirected to Nomad to complete setup after checkout
        </div>
      `;
      
      document.body.appendChild(confirmation);
      
      // Remove after 4 seconds
      setTimeout(() => {
        if (confirmation.parentNode) {
          confirmation.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => {
            if (confirmation.parentNode) {
              document.body.removeChild(confirmation);
            }
          }, 300);
        }
      }, 4000);
    }
    
    // Update checkout total when Nomad add-on is selected
    function updateCheckoutWithNomad() {
      const nomadAddon = document.getElementById('nomad-addon');
      if (nomadAddon && nomadAddon.checked) {
        // Add Nomad to cart or update total
        const nomadItem = {
          id: 'nomad-internet',
          name: 'Nomad Internet - Unlimited Wireless',
          price: 47.96,
          qty: 1,
          description: 'Monthly unlimited internet service with free modem'
        };
        
        // Store in session for checkout
        sessionStorage.setItem('nomadAddon', JSON.stringify(nomadItem));
        
        // Update the total display
        const totalElement = document.querySelector('.price-row .total');
        if (totalElement) {
          const currentTotal = parseFloat(totalElement.textContent.replace(/[^0-9.]/g, ''));
          const newTotal = currentTotal + 47.96;
          totalElement.textContent = fmt(newTotal);
        }
      } else {
        // Remove from session
        sessionStorage.removeItem('nomadAddon');
      }
    }

    // Apple Trade‑In UI
    $('#apple-begin').addEventListener('click', async ()=>{
      openFlow({ title:'Apple Authorized Trade‑In', body:'<p>Enter your device model to begin.</p><input id="apple-model" class="chip" placeholder="e.g., iPhone 13">', actions:[{label:'Next', handler: async ()=>{
        const model = $('#apple-model').value || 'iPhone'; const q = await AppleTradeIn.quote(model);
        flowBody.innerHTML = `<p>Estimated credit for <strong>${model}</strong>: <span class='chip'>${fmt(q.amount)}</span></p>`;
      }}] });
    });

    // Enhanced Progressive UI
    $('#lease-prequal').addEventListener('click', async ()=>{
      const name = $('#lease-name').value;
      const email = $('#lease-email').value;
      const phone = $('#lease-phone').value;
      const zip = $('#lease-zip').value;
      const amount = readCart().reduce((s,i)=>s+i.price*i.qty,0);
      
      if (!name || !email || !phone || !zip) {
        alert('Please fill in all required fields.');
        return;
      }
      
      if (!PMM_UTILS.validateEmail(email)) {
        alert('Please enter a valid email address.');
        return;
      }
      
      $('#lease-output').textContent = 'Checking pre-qualification...';
      const res = await ProgressiveLeasing.prequalify({ name, email, phone, zip, amount });
      
      if (res.status === 'approved') {
        $('#lease-output').innerHTML = `
          <div style="background: #0a0a0a; padding: 16px; border-radius: 12px; border: 1px solid #161616; margin: 12px 0;">
            <h4 style="margin: 0 0 12px 0; color: var(--accent-2);">✅ Pre-Qualified!</h4>
            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
              <span>Credit Limit:</span>
              <span><strong>${PMM_UTILS.formatPrice(res.limit)}</strong></span>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
              <span>Monthly Payment:</span>
              <span><strong>${PMM_UTILS.formatPrice(res.monthlyPayment)}</strong></span>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
              <span>Terms:</span>
              <span>${res.terms}</span>
            </div>
            <div style="margin-top: 12px;">
              <button class="btn" id="lease-apply" style="width: 100%;">Apply for Lease</button>
            </div>
          </div>`;
        
        $('#lease-apply').onclick = async () => {
          const items = readCart();
          if (items.length === 0) {
            alert('Please add items to your cart first.');
            return;
          }
          await ProgressiveLeasing.startFromCart(items);
        };
      } else {
        $('#lease-output').innerHTML = `
          <div style="background: #0a0a0a; padding: 16px; border-radius: 12px; border: 1px solid #161616; margin: 12px 0;">
            <h4 style="margin: 0 0 12px 0; color: #ff6b6b;">❌ Not Pre-Qualified</h4>
            <p style="margin: 0 0 8px 0;">${res.reason}</p>
            ${res.suggestions ? `<ul style="margin: 8px 0; padding-left: 20px;"><li>${res.suggestions.join('</li><li>')}</li></ul>` : ''}
          </div>`;
      }
    });

    // Nomad UI
    $('#nomad-check').addEventListener('click', async ()=>{
      const zip = $('#nomad-zip').value.trim();
      const res = await Nomad.availability(zip);
      if(!res.ok){ $('#nomad-output').innerHTML = '<p>No coverage found. Try another ZIP.</p>'; return; }
      $('#nomad-output').innerHTML = `<div>${res.plans.map(p=>`<div class='row' style='justify-content:space-between; border-bottom:1px solid #161616; padding:8px 0'>
        <div><strong>${p.name}</strong><br><span class='chip'>${p.down}</span></div>
        <div class='row'><span class='chip'>${fmt(p.price)}/mo</span> <button class='btn' data-plan='${p.id}'>Order</button></div>
      </div>`).join('')}</div>`;
      $$('#nomad-output [data-plan]').forEach(btn=> btn.addEventListener('click', async e=>{
        const planId = e.currentTarget.getAttribute('data-plan');
        openFlow({ title:'Nomad Order', body:`<p>Plan: <strong>${planId}</strong></p><div class='row'><input id='nm-name' class='chip' placeholder='Full name'><input id='nm-email' class='chip' placeholder='Email'></div>`, actions:[{label:'Submit', handler: async ()=>{
          const customer = { name: $('#nm-name').value, email: $('#nm-email').value, zip: $('#nomad-zip').value };
          const out = await Nomad.order(planId, customer); flowBody.innerHTML = renderJSON(out);
        }}] });
      }));
    });

    // Quick action buttons up top
    document.getElementById('btn-phobio-quote').addEventListener('click', ()=> document.getElementById('phobio-model').focus());
    document.getElementById('btn-apple-trade').addEventListener('click', ()=> document.getElementById('apple-begin').click());
    document.getElementById('btn-progressive').addEventListener('click', ()=> document.getElementById('lease-name').focus());
    document.getElementById('btn-nomad').addEventListener('click', ()=> document.getElementById('nomad-zip').focus());
    
    // Back to products button
    document.getElementById('back-to-products').addEventListener('click', showProducts);
    
    // Payment method switching
    document.addEventListener('change', function(e) {
      if (e.target.name === 'payment-method') {
        const cardForm = document.getElementById('card-payment-form');
        const progressiveForm = document.getElementById('progressive-payment-form');
        const cardOption = document.getElementById('card-option');
        const progressiveOption = document.getElementById('progressive-option');
        
        if (e.target.value === 'card') {
          cardForm.style.display = 'block';
          progressiveForm.style.display = 'none';
          cardOption.style.borderColor = 'var(--accent)';
          progressiveOption.style.borderColor = '#161616';
        } else if (e.target.value === 'progressive') {
          cardForm.style.display = 'none';
          progressiveForm.style.display = 'block';
          progressiveOption.style.borderColor = 'var(--accent)';
          cardOption.style.borderColor = '#161616';
        }
      }
    });

    /***** 6) Helpers *****/
    function sleep(ms){ return new Promise(r=> setTimeout(r, ms)); }
    function rnd(){ return Math.random().toString(36).slice(2,8).toUpperCase(); }
    function renderJSON(o){ return `<pre style="white-space:pre-wrap; background:#0a0a0a; padding:12px; border-radius:12px; border:1px solid #161616;">${escapeHTML(JSON.stringify(o, null, 2))}</pre>`; }
    function escapeHTML(s){ return s.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\\':'\\'}[c])); }

    // Keyboard: Esc closes modals
    document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ try{$('#flow-modal').close()}catch{} try{$('#cart-modal').close()}catch{} } });

  </script>
</body>
</html>
